name: MLB Full Daily Pipeline

on:
  workflow_dispatch:

jobs:
  run-full-mlb-pipeline:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-west-2
      S3_BUCKET: fantasy-sports-csvs
      BASEBALL_DIR: baseball

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install boto3 pytz

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download raw files from S3
        run: |
          aws s3 cp s3://$S3_BUCKET/$BASEBALL_DIR/betting/ ./betting/ --recursive
          aws s3 cp s3://$S3_BUCKET/$BASEBALL_DIR/weather/ ./weather/ --recursive
          aws s3 cp s3://$S3_BUCKET/$BASEBALL_DIR/rosters/ ./rosters/ --recursive
          aws s3 cp s3://$S3_BUCKET/$BASEBALL_DIR/probablestarters/ ./probablestarters/ --recursive
          aws s3 cp s3://$S3_BUCKET/$BASEBALL_DIR/news/ ./news/ --recursive
          aws s3 cp s3://$S3_BUCKET/$BASEBALL_DIR/boxscores/ ./boxscores/ --recursive

      - name: Create output folder
        run: mkdir -p baseball/combined

      - name: Run combine script to generate structured file
        run: |
            echo "üöÄ Running combine script..."
            python mlb_combine_all_files.py
            echo "‚úÖ Combine script completed."

      - name: Run analyzer script to enhance structured file
        run: |
            echo "üìä Enhancing structured file..."
            python player_stats_analyzer.py
            echo "‚úÖ Enhancement complete."

      - name: Debug structured file contents
        run: |
          echo "üìÇ Listing files in baseball/combined:"
          ls -lh baseball/combined/
          echo "üìÑ Preview structured file:"
          cat $(ls -t baseball/combined/structured_players_*.json | head -n 1) || echo "‚ùå Structured file not found or empty."

      - name: Upload structured file to S3
        run: aws s3 cp ./baseball/combined/ s3://$S3_BUCKET/$BASEBALL_DIR/combined/ --recursive

      - name: Run analyzer script to enhance structured file
        run: |
          echo "üìä Enhancing structured file..."
          python mlb_baseball_article_generator/player_stats_analyzer.py
          echo "‚úÖ Enhancement complete."

      - name: Upload enhanced file to S3
        run: aws s3 cp ./baseball/combined/ s3://$S3_BUCKET/$BASEBALL_DIR/combined/ --recursive
